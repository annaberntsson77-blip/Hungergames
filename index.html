<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>5‑kamp – Poäng & Lag (Realtime)</title>
  <style>
    :root {
      --bg: #0f172a;         /* slate-900 */
      --panel: #111827;      /* gray-900 */
      --muted: #94a3b8;      /* slate-400 */
      --text: #e5e7eb;       /* gray-200 */
      --accent: #22c55e;     /* green-500 */
      --accent-2: #06b6d4;   /* cyan-500 */
      --warn: #f59e0b;       /* amber-500 */
      --danger: #ef4444;     /* red-500 */
      --card: #0b1220;       /* deep */
      --border: #1f2937;     /* gray-800 */
    }
    * { box-sizing: border-box }
    html, body { height: 100% }
    body {
      margin: 0; background: radial-gradient(1200px 600px at 10% -10%, #0b1220 10%, #0f172a 50%, #0a0f1f 100%);
      color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    header { padding: 24px; position: sticky; top: 0; z-index: 5; backdrop-filter: blur(6px); background: color-mix(in oklab, var(--bg) 80%, transparent) }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 0 20px }
    h1 { margin: 0; font-size: clamp(22px, 2.6vw, 34px); letter-spacing: 0.2px }
    .sub { color: var(--muted); font-size: 14px; margin-top: 6px }

    .grid { display: grid; grid-template-columns: 1fr 360px; gap: 20px; align-items: start; margin-top: 20px }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr } }

    .card { background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); border: 1px solid var(--border); border-radius: 16px; box-shadow: 0 4px 30px rgba(0,0,0,0.25); }

    .controls { padding: 16px; display: flex; flex-wrap: wrap; gap: 10px }
    .controls input[type="text"], .controls input[type="number"] { background: var(--card); color: var(--text); border: 1px solid var(--border); border-radius: 12px; padding: 10px 12px; outline: none; width: min(280px, 100%); }
    .btn { background: var(--panel); color: var(--text); border: 1px solid var(--border); border-radius: 12px; padding: 10px 12px; cursor: pointer; transition: 150ms transform ease, 150ms background ease; }
    .btn:hover { transform: translateY(-1px) }
    .btn.primary { background: linear-gradient(90deg, var(--accent), var(--accent-2)); border: none; color: #071316; font-weight: 600 }
    .btn.warn { background: #2a1a00; border-color: #7a4d00; color: #ffdd9a }
    .btn.danger { background: #2a0b0b; border-color: #7a1f1f; color: #ffc0c0 }

    .table-wrap { overflow: auto; border-top-left-radius: 16px; border-top-right-radius: 16px }
    table { width: 100%; border-collapse: collapse; min-width: 720px }
    thead { background: #0a1322 }
    th, td { padding: 10px 12px; border-bottom: 1px solid var(--border); text-align: left; font-size: 14px }
    th { position: sticky; top: 0; z-index: 2 }
    tbody tr:hover { background: rgba(255,255,255,0.03) }
    .rank { width: 52px; text-align: center; color: #a3e635; font-weight: 700 }

    .input-pts { width: 70px; background: var(--card); border: 1px solid var(--border); color: var(--text); padding: 8px; border-radius: 10px; text-align: right }

    .ghost { opacity: 0.7 }
    .hint { color: var(--muted); font-size: 12px }

    .side { padding: 16px }
    .side h3 { margin: 8px 0 4px; font-size: 16px }
    .side .small { font-size: 12px; color: var(--muted) }
    .qr-box { display: grid; grid-template-columns: 1fr; gap: 10px; align-items: center }
    #qrcode { background: #fff; padding: 12px; border-radius: 12px; display: grid; place-items: center }
    .footer { padding: 14px 16px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap }
    .link { color: #93c5fd; text-decoration: underline; cursor: pointer }
    .badge { display:inline-flex; gap:6px; align-items:center; font-size:12px; background:#052a1a; color:#86efac; border:1px solid #14532d; border-radius:999px; padding:4px 10px }
    code { background:#091626; padding:2px 6px; border-radius:6px; border:1px solid #0b2344 }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>5‑kamp · Poängräknare <span id="liveBadge" class="badge" title="Flera kan uppdatera samtidigt">• Live</span></h1>
      <div class="sub">Delad resultattavla för 5 grenar. Flera lag kan uppdatera samtidigt – allt synkas via Supabase. Välj eller skapa "Spelkod" och dela länken för att köra samma omgång.</div>
    </div>
  </header>

  <main class="wrap grid">
    <section class="card">
      <div class="controls">
        <input id="teamName" type="text" placeholder="Lagnamn" />
        <button class="btn primary" id="addTeamBtn">Lägg till lag</button>
        <button class="btn warn" id="resetPointsBtn" title="Sätt alla poäng till 0">Nollställ poäng</button>
        <button class="btn danger" id="clearAllBtn" title="Ta bort alla lag i denna spelkod">Rensa denna omgång</button>
        <span class="hint">Tips: Flera kan vara inne samtidigt. Poäng och lag synkas live.</span>
      </div>
      <div class="table-wrap">
        <table id="scoreTable">
          <thead>
            <tr>
              <th class="rank">#</th>
              <th>Lag</th>
              <th id="hth1">Gren 1</th>
              <th id="hth2">Gren 2</th>
              <th id="hth3">Gren 3</th>
              <th id="hth4">Gren 4</th>
              <th id="hth5">Gren 5</th>
              <th>Totalt</th>
              <th>Ta bort</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="footer">
        <div class="hint">Spelkod: <code id="gameCode"></code> · Dela länken nedan till alla domare/lag.</div>
        <div>
          <button class="btn" id="printBtn">Skriv ut/ PDF</button>
          <button class="btn" id="shareBtn">Dela länk</button>
        </div>
      </div>
    </section>

    <aside class="card side">
      <h3>Spelkod & länk</h3>
      <div class="small">Varje omgång har en unik <em>spelkod</em>. Alla som öppnar länken med samma kod ser/ändrar samma tavla.</div>
      <div style="display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; margin-top:8px">
        <input id="gameInput" type="text" placeholder="t.ex. FEST25" />
        <button class="btn" id="useGameBtn">Använd</button>
      </div>
      <div class="small" style="margin-top:6px">Delningslänk: <div><code id="shareLink"></code></div></div>

      <h3 style="margin-top:18px">QR‑kod till länken</h3>
      <div class="qr-box" style="margin-top:6px">
        <button class="btn" id="genQrBtn">Skapa QR‑kod</button>
        <div id="qrcode"></div>
        <button class="btn" id="downloadQrBtn" disabled>Ladda ner QR (PNG)</button>
      </div>

      <h3 style="margin-top:18px">Byt namn på grenar</h3>
      <div class="small">Sparas i databasen för denna spelkod.</div>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:8px">
        <input id="h1" class="input-pts" placeholder="Gren 1" />
        <input id="h2" class="input-pts" placeholder="Gren 2" />
        <input id="h3" class="input-pts" placeholder="Gren 3" />
        <input id="h4" class="input-pts" placeholder="Gren 4" />
        <input id="h5" class="input-pts" placeholder="Gren 5" />
        <button class="btn" id="saveHeaders">Spara namn</button>
      </div>

      <div style="margin-top:18px" class="small">Drivs av Supabase Realtime. Öppna samma länk på flera enheter för synkad score.</div>
    </aside>
  </main>

  <!-- QRCode.js (tiny draw) -->
  <script>
    function drawQR(text, target){
      // Use URL.createObjectURL + offscreen canvas rendering to keep tiny.
      // Minimalistic QR via third-party libs would be larger; for brevity we reuse canvas drawing from original.
      // Here we lean on a simple imported lib if available; otherwise show fallback using Google Chart (deprecated but ok for quick use).
      // For reliability in offline, we embed a very small QR renderer.
      const c = document.createElement('canvas');
      c.width = c.height = 260; const ctx = c.getContext('2d');
      ctx.fillStyle = '#fff'; ctx.fillRect(0,0,260,260);
      // Fallback: draw a centered text QR placeholder, since real QR gen is in prior version.
      // To keep code shorter here, we call an external QuickChart QR API image (no key) for the canvas.
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = ()=>{ ctx.drawImage(img,0,0,260,260); target.innerHTML=''; target.appendChild(c); target.dataset.ready='1'; };
      img.onerror = ()=>{ target.textContent='Kunde inte skapa QR'; };
      img.src = `https://quickchart.io/qr?text=${encodeURIComponent(text)}&size=260`;
      return c;
    }
  </script>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ====== KONFIGURATION: Fyll i dina Supabase-detaljer ======
    const SUPABASE_URL = 'https://fauzomdmcpxiqibpivbx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZhdXpvbWRtY3B4aXFpYnBpdmJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNzA1MDUsImV4cCI6MjA3MDk0NjUwNX0.GveDfZO1KLnaQ5F_kmsOuWMYlrFIJEwR9F7pNtgksnw';
    // ==========================================================

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: false } });

    const DEFAULT_HEADERS = ['Gren 1','Gren 2','Gren 3','Gren 4','Gren 5'];
    const el = s => document.querySelector(s);
    const tbody = el('#tbody');

    // Spelkod från URL (?game=KOD) eller skapa ny
    function randomCode(){ return Math.random().toString(36).toUpperCase().replace(/[^A-Z0-9]/g,'').slice(2,8) }
    const url = new URL(location.href);
    let GAME = url.searchParams.get('game') || randomCode();
    updateShareLink();

    el('#gameInput').value = GAME;
    el('#gameCode').textContent = GAME;

    el('#useGameBtn').addEventListener('click', async ()=>{
      const v = el('#gameInput').value.trim().toUpperCase().replace(/[^A-Z0-9\-]/g,'');
      if(!v) return;
      GAME = v;
      url.searchParams.set('game', GAME);
      history.replaceState(null,'', url.toString());
      el('#gameCode').textContent = GAME;
      updateShareLink();
      await ensureHeaderRow();
      subscribeRealtime();
      await loadHeaders();
      await loadTeams();
    });

    function updateShareLink(){
      const share = new URL(location.href);
      share.searchParams.set('game', GAME);
      el('#shareLink').textContent = share.toString();
    }

    function teamTotal(t){ return (t.p1|0)+(t.p2|0)+(t.p3|0)+(t.p4|0)+(t.p5|0); }

    async function ensureHeaderRow(){
      // Headers lagras i tabell headers: game text pk, h1..h5 text
      await supabase.from('headers').upsert({ game: GAME }, { onConflict: 'game' });
    }

    async function loadHeaders(){
      const { data, error } = await supabase.from('headers').select('*').eq('game', GAME).single();
      const h = data ? [data.h1, data.h2, data.h3, data.h4, data.h5] : [];
      for(let i=1;i<=5;i++){
        const val = h[i-1] || DEFAULT_HEADERS[i-1];
        el('#hth'+i).textContent = val;
        el('#h'+i).value = val;
      }
    }

    el('#saveHeaders').addEventListener('click', async ()=> {
      const payload = { 
        game: GAME, 
        h1: el('#h1').value||null, 
        h2: el('#h2').value||null, 
        h3: el('#h3').value||null, 
        h4: el('#h4').value||null, 
        h5: el('#h5').value||null
      };
      const { error } = await supabase.from('headers').upsert(payload, { onConflict: 'game' });
      if(error){ 
        console.error(error); 
        alert('Kunde inte spara grennamn.');
      }
      await loadHeaders();
    });

    async function loadTeams(){
      const { data, error } = await supabase.from('teams').select('*').eq('game', GAME);
      if(error) { 
        console.error(error); 
        return;
      }
      renderTeams(data || []);
    }

    function renderTeams(list){
      list.sort((a, b) => teamTotal(b) - teamTotal(a) || a.name.localeCompare(b.name));
      tbody.innerHTML = '';
      list.forEach((t, idx) => {
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td class="rank">${idx+1}</td>
          <td><input data-id="${t.id}" class="team-name input-pts" style="width:170px;text-align:left" value="${escapeHtml(t.name||'')}"/></td>
          ${[1,2,3,4,5].map(i=>`<td><input class="input-pts pts" data-id="${t.id}" data-gren="${i}" type="number" min="0" step="1" value="${Number(t['p'+i])||0}"/></td>`).join('')}
          <td><strong>${teamTotal(t)}</strong></td>
          <td><button class="btn danger del" data-id="${t.id}">Ta bort</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function escapeHtml(str=''){ return str.replace(/[&<>\"]+/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[s])); }

    el('#addTeamBtn').addEventListener('click', async ()=>{
      const name = el('#teamName').value.trim() || `Lag ${Math.floor(Math.random()*90+10)}`;
      el('#teamName').value='';
      const { error } = await supabase.from('teams').insert({ game: GAME, name, p1:0,p2:0,p3:0,p4:0,p5:0 });
      if(error){
        console.error('Insert error:', error);
        alert('Kunde inte lägga till lag. Kontrollera att tabellen "teams" finns, RLS-policys är satta och Realtime är påslaget.');
      }
      await loadTeams();
    });

    tbody.addEventListener('input', debounce(async (ev)=>{
      const t = ev.target;
      const id = t.getAttribute('data-id');
      if(t.classList.contains('pts')){
        const i = t.getAttribute('data-gren');
        const val = Number(t.value)||0;
        await supabase.from('teams').update({ ['p'+i]: val }).eq('id', id).eq('game', GAME);
      }
      if(t.classList.contains('team-name')){
        await supabase.from('teams').update({ name: t.value }).eq('id', id).eq('game', GAME);
      }
    }, 180));

    tbody.addEventListener('click', async (ev)=>{
      const b = ev.target.closest('button.del');
      if(!b) return;
      const id=b.getAttribute('data-id');
      if(!confirm('Ta bort detta lag?')) return;
      await supabase.from('teams').delete().eq('id', id).eq('game', GAME);
    });

    el('#resetPointsBtn').addEventListener('click', async ()=>{
      if(!confirm('Sätt alla poäng i denna omgång till 0?')) return;
      await supabase.rpc('reset_points', { gcode: GAME });
    });

    el('#clearAllBtn').addEventListener('click', async ()=>{
      if(!confirm('Ta bort alla lag i denna omgång?')) return;
      await supabase.from('teams').delete().eq('game', GAME);
    });

    el('#printBtn').addEventListener('click', ()=> window.print());

    el('#shareBtn').addEventListener('click', async ()=>{
      const share = el('#shareLink').textContent;
      try{ if(navigator.share) await navigator.share({ title:'5‑kamp', url: share }); else prompt('Kopiera länken:', share); }catch(e){}
    });

    // ====== Realtime ======
    let channel;
    function subscribeRealtime(){
      if(channel) supabase.removeChannel(channel);
      channel = supabase.channel('teams_'+GAME)
        .on('postgres_changes', { event: '*', schema: 'public', table: 'teams', filter: `game=eq.${GAME}` }, (payload)=>{ loadTeams(); })
        .on('postgres_changes', { event: '*', schema: 'public', table: 'headers', filter: `game=eq.${GAME}` }, (payload)=>{ loadHeaders(); })
        .subscribe((status)=>{ /* noop */ });
    }

    // ====== Start ======
    (async function init(){
      await ensureHeaderRow();
      subscribeRealtime();
      await loadHeaders();
      await loadTeams();
    })();

    // ====== Debounce helper ======
    function debounce(fn, ms){ let t; return function(...args){ clearTimeout(t); t=setTimeout(()=>fn.apply(this,args), ms); } }

    // ====== QR actions ======
    const qrBox = document.getElementById('qrcode');
    const dlBtn = document.getElementById('downloadQrBtn');
    document.getElementById('genQrBtn').addEventListener('click', ()=>{
      const link = el('#shareLink').textContent;
      drawQR(link, qrBox);
      dlBtn.disabled=false;
    });
    dlBtn.addEventListener('click', ()=>{
      const img = qrBox.querySelector('canvas');
      if(!img) return;
      const a = document.createElement('a');
      a.href = img.toDataURL('image/png');
      a.download = '5kamp-QR.png';
      a.click();
    });
  </script>
</body>
</html>
