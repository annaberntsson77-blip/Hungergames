<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>5‚Äëkamp ‚Äì Po√§ng & Lag (Realtime)</title>
  <style>
    :root {
      --bg: #0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --border:#1f2937; --card:#0b1220;
      --ok:#22c55e; --info:#06b6d4; --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#0b1220;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans",Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    h1{margin:10px 0 8px;font-size:clamp(22px,2.6vw,34px)}
    .sub{color:var(--muted);font-size:14px}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:18px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid var(--border);border-radius:14px}
    .controls{padding:12px;display:flex;flex-wrap:wrap;gap:8px}
    input[type="text"],input[type="number"]{background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:9px 10px}
    .btn{background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:9px 12px;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--ok),var(--info));border:none;color:#052012;font-weight:600}
    .table-wrap{overflow:auto;border-top-left-radius:14px;border-top-right-radius:14px}
    table{width:100%;border-collapse:collapse;min-width:760px}
    thead{background:#0a1322}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
    .rank{width:52px;text-align:center;color:#a3e635;font-weight:700}
    .input-pts{width:70px;text-align:right}
    #scoreSummary{margin-bottom:16px;padding:12px;background:rgba(255,255,255,0.05);border-radius:12px}
    #scoreSummary h3{margin:0 0 8px;font-size:16px}
    #scoreSummary ul{list-style:none;padding:0;margin:0}
    #scoreSummary li{padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.1)}
    #scoreSummary li:last-child{border-bottom:none}
    #scoreSummary li.first-place{font-weight:700;color:#facc15}
    #scoreSummary li.first-place::before{content:"ü•á ";}
    #scoreSummary li.second-place{font-weight:700;color:#9ca3af}
    #scoreSummary li.second-place::before{content:"ü•à ";}
    #scoreSummary li.third-place{font-weight:700;color:#d97706}
    #scoreSummary li.third-place::before{content:"ü•â ";}
    #detailsHeader{margin:10px 0 6px;font-size:18px;font-weight:700}
    .side{padding:14px}
    .small{color:var(--muted);font-size:12px}
    code{background:#091626;border:1px solid #0b2344;border-radius:6px;padding:2px 6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>5‚Äëkamp ¬∑ Po√§ngr√§knare <span class="small">(realtid via Supabase)</span></h1>
    <div class="sub">Dela samma <em>spelkod</em> s√• synkas allt mellan alla enheter. Du kan byta grennamn i panelen.</div>

    <!-- Totalsummor √∂ver tabellen -->
    <div id="scoreSummary" class="card">
      <h3>Totalsummor</h3>
      <ul id="summaryList"></ul>
    </div>

    <h3 id="detailsHeader">Detaljerad po√§ng per gren</h3>

    <div class="grid">
      <section class="card">
        <div class="controls">
          <input id="teamName" type="text" placeholder="Lagnamn" />
          <button class="btn primary" id="addTeamBtn">L√§gg till lag</button>
          <span class="small">Spelkod: <code id="gameCode"></code></span>
        </div>
        <div class="table-wrap">
          <table id="scoreTable">
            <thead>
              <tr>
                <th class="rank">#</th>
                <th>Lag</th>
                <th id="hth1">Gren 1</th>
                <th id="hth2">Gren 2</th>
                <th id="hth3">Gren 3</th>
                <th id="hth4">Gren 4</th>
                <th id="hth5">Gren 5</th>
                <th>Totalt</th>
                <th>Ta bort</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </section>

      <aside class="card side">
        <h3>Spelkod & delning</h3>
        <div class="small">Anv√§nd samma kod p√• alla enheter f√∂r att dela omg√•ng.</div>
        <div style="display:grid;grid-template-columns:1fr auto;gap:8px;margin-top:6px">
          <input id="gameInput" type="text" placeholder="t.ex. FEST25" />
          <button class="btn" id="useGameBtn">Anv√§nd</button>
        </div>
        <div class="small" style="margin-top:6px">L√§nk att dela: <div><code id="shareLink"></code></div></div>

        <h3 style="margin-top:14px">Byt namn p√• grenar</h3>
        <div class="small">Sparas f√∂r denna spelkod.</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <input id="h1" class="input-pts" placeholder="Gren 1" />
          <input id="h2" class="input-pts" placeholder="Gren 2" />
          <input id="h3" class="input-pts" placeholder="Gren 3" />
          <input id="h4" class="input-pts" placeholder="Gren 4" />
          <input id="h5" class="input-pts" placeholder="Gren 5" />
          <button class="btn" id="saveHeaders">Spara namn</button>
        </div>

        <h3 style="margin-top:14px">QR‚Äëkod</h3>
        <div class="small">Skapa QR f√∂r delningsl√§nken.</div>
        <button class="btn" id="genQrBtn" style="margin-top:6px">Skapa QR‚Äëkod</button>
        <div id="qrcode" style="background:#fff;padding:10px;border-radius:10px;margin-top:8px;display:grid;place-items:center"></div>
        <button class="btn" id="downloadQrBtn" disabled>Ladda ner QR (PNG)</button>
      </aside>
    </div>
  </div>

  <!-- QR (via QuickChart bild) -->
  <script>
    function drawQR(text, target){
      const c=document.createElement('canvas'); c.width=c.height=260; const ctx=c.getContext('2d');
      ctx.fillStyle='#fff'; ctx.fillRect(0,0,260,260);
      const img=new Image(); img.crossOrigin='anonymous';
      img.onload=()=>{ ctx.drawImage(img,0,0,260,260); target.innerHTML=''; target.appendChild(c); target.dataset.ready='1'; };
      img.onerror=()=>{ target.textContent='Kunde inte skapa QR'; };
      img.src=`https://quickchart.io/qr?text=${encodeURIComponent(text)}&size=260`;
      return c;
    }
  </script>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ====== KONFIGURATION: Fyll i dina Supabase-detaljer ======
    const SUPABASE_URL = 'https://fauzomdmcpxiqibpivbx.supabase.co';https://fauzomdmcpxiqibpivbx.supabase.co
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZhdXpvbWRtY3B4aXFpYnBpdmJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNzA1MDUsImV4cCI6MjA3MDk0NjUwNX0.GveDfZO1KLnaQ5F_kmsOuWMYlrFIJEwR9F7pNtgksnw';
    // ==========================================================

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: false } });

    const DEFAULT_HEADERS = ['Gren 1','Gren 2','Gren 3','Gren 4','Gren 5'];
    const el = s => document.querySelector(s);
    const tbody = el('#tbody');
    const summaryList = el('#summaryList');

    // Spelkod fr√•n URL (?game=KOD) eller skapa ny
    const url = new URL(location.href);
    function randomCode(){ return Math.random().toString(36).toUpperCase().replace(/[^A-Z0-9]/g,'').slice(2,8) }
    let GAME = url.searchParams.get('game') || randomCode();
    el('#gameCode').textContent = GAME;
    el('#gameInput').value = GAME;
    updateShareLink();

    // --- Hj√§lpare ---
    function escapeHtml(str=''){ return str.replace(/[&<>\"]/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[s])); }
    function teamTotal(t){ return (t.p1|0)+(t.p2|0)+(t.p3|0)+(t.p4|0)+(t.p5|0); }
    function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms) }; }

    // --- UI wiring ---
    el('#useGameBtn').addEventListener('click', async ()=>{
      const v = el('#gameInput').value.trim().toUpperCase().replace(/[^A-Z0-9\-]/g,'');
      if(!v) return; GAME=v; el('#gameCode').textContent=GAME;
      url.searchParams.set('game', GAME); history.replaceState(null,'',url.toString());
      updateShareLink(); await ensureHeaderRow(); subscribeRealtime(); await loadHeaders(); await loadTeams();
    });

    el('#addTeamBtn').addEventListener('click', async ()=>{
      const name = el('#teamName').value.trim() || `Lag ${Math.floor(Math.random()*90+10)}`;
      el('#teamName').value='';
      const { error } = await supabase.from('teams').insert({ game: GAME, name, p1:0,p2:0,p3:0,p4:0,p5:0 });
      if(error){ console.error(error); alert('Kunde inte l√§gga till lag ‚Äì kontrollera "teams"-tabell och policies.'); }
      await loadTeams();
    });

    el('#saveHeaders').addEventListener('click', async ()=>{
      const payload = { game: GAME, h1: el('#h1').value||null, h2: el('#h2').value||null, h3: el('#h3').value||null, h4: el('#h4').value||null, h5: el('#h5').value||null };
      const { error } = await supabase.from('headers').upsert(payload, { onConflict: 'game' });
      if(error){ console.error(error); alert('Kunde inte spara grennamn.'); }
      await loadHeaders();
    });

    // Po√§ng + namn i tabellen
    tbody.addEventListener('input', debounce(async (ev)=>{
      const t = ev.target; const id=t.getAttribute('data-id'); if(!id) return;
      if(t.classList.contains('pts')){ const i=t.getAttribute('data-gren'); const val=Number(t.value)||0; await supabase.from('teams').update({['p'+i]:val}).eq('id',id).eq('game',GAME); }
      if(t.classList.contains('team-name')){ await supabase.from('teams').update({ name:t.value }).eq('id',id).eq('game',GAME); }
    },180));

    tbody.addEventListener('click', async (ev)=>{
      const b=ev.target.closest('button.del'); if(!b) return; const id=b.getAttribute('data-id');
      if(!confirm('Ta bort detta lag?')) return; await supabase.from('teams').delete().eq('id',id).eq('game',GAME);
    });

    // QR
    const qrBox=document.getElementById('qrcode'); const dlBtn=document.getElementById('downloadQrBtn');
    document.getElementById('genQrBtn').addEventListener('click', ()=>{ drawQR(el('#shareLink').textContent, qrBox); dlBtn.disabled=false; });
    dlBtn.addEventListener('click', ()=>{ const c=qrBox.querySelector('canvas'); if(!c) return; const a=document.createElement('a'); a.href=c.toDataURL('image/png'); a.download='5kamp-QR.png'; a.click(); });

    // --- Supabase helpers ---
    function updateShareLink(){ const s=new URL(location.href); s.searchParams.set('game', GAME); el('#shareLink').textContent=s.toString(); }

    async function ensureHeaderRow(){ await supabase.from('headers').upsert({ game: GAME }, { onConflict:'game' }); }

    async function loadHeaders(){
      const { data } = await supabase.from('headers').select('*').eq('game',GAME).maybeSingle();
      const h=[data?.h1,data?.h2,data?.h3,data?.h4,data?.h5];
      for(let i=1;i<=5;i++){ const v=h[i-1]||DEFAULT_HEADERS[i-1]; document.getElementById('hth'+i).textContent=v; el('#h'+i).value=v; }
    }

    async function loadTeams(){
      const { data, error } = await supabase.from('teams').select('*').eq('game',GAME);
      if(error){ console.error(error); return; }
      renderTeams(data||[]);
    }

    function renderTeams(list){
      list.sort((a,b)=> teamTotal(b)-teamTotal(a) || a.name.localeCompare(b.name));
      tbody.innerHTML=''; summaryList.innerHTML='';
      list.forEach((t,idx)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td class="rank">${idx+1}</td>
          <td><input data-id="${t.id}" class="team-name input-pts" style="width:170px;text-align:left" value="${escapeHtml(t.name||'')}"/></td>
          ${[1,2,3,4,5].map(i=>`<td><input class="input-pts pts" data-id="${t.id}" data-gren="${i}" type="number" min="0" step="1" value="${Number(t['p'+i])||0}"/></td>`).join('')}
          <td><strong>${teamTotal(t)}</strong></td>
          <td><button class="btn del" data-id="${t.id}">Ta bort</button></td>`;
        tbody.appendChild(tr);
      });
      const sorted=[...list].sort((a,b)=>teamTotal(b)-teamTotal(a));
      sorted.forEach((t,i)=>{ const li=document.createElement('li'); li.textContent=`${t.name}: ${teamTotal(t)}`; if(i===0)li.classList.add('first-place'); else if(i===1)li.classList.add('second-place'); else if(i===2)li.classList.add('third-place'); summaryList.appendChild(li); });
    }

    // Realtime
    let channel;
    function subscribeRealtime(){
      if(channel) supabase.removeChannel(channel);
      channel = supabase.channel('live_'+GAME)
        .on('postgres_changes',{event:'*',schema:'public',table:'teams',filter:`game=eq.${GAME}`},()=>loadTeams())
        .on('postgres_changes',{event:'*',schema:'public',table:'headers',filter:`game=eq.${GAME}`},()=>loadHeaders())
        .subscribe();
    }

    // Start
    (async function init(){
      await ensureHeaderRow(); subscribeRealtime(); await loadHeaders(); await loadTeams();
    })();
  </script>
</body>
</html>
